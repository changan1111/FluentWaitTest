const express = require('express');
const bodyparser = require('body-parser');
const cors = require('cors');
const sql = require('mssql');
const Chart = require('chart.js');

const app = express();
app.use(cors());
app.use(bodyparser.json());

var dbConfig = {
  server: '{hostname}\\MSSQLSERVER02',
  database: 'master',
  user: 'sa',
  password: 'password',
  options: {
    encrypt: true,
    enableArithAbort: true,
    trustServerCertificate: true,
  },
};

// Fetch the distinct page names from the SQL Server database
async function getPageNames() {
  try {
    await sql.connect(dbConfig);

    const result = await sql.query('SELECT DISTINCT PageName FROM Performance');

    return result.recordset;
  } catch (error) {
    console.error('Error fetching page names:', error);
    throw error;
  }
}

// Fetch the page load times from the SQL Server database for the selected page
async function getPageLoadTimes(pageName) {
  try {
    await sql.connect(dbConfig);

    let query = 'SELECT * FROM Performance';
    if (pageName) {
      query += ` WHERE PageName = '${pageName}'`;
    }

    const result = await sql.query(query);

    return result.recordset;
  } catch (error) {
    console.error('Error fetching page load times:', error);
    throw error;
  }
}

// Calculate the load time statistics for all pages
async function calculateLoadTimeStatsForAllPages(pageNames) {
  try {
    const stats = [];

    for (const page of pageNames) {
      const pageLoadTimes = await getPageLoadTimes(page.PageName);
      const loadTimes = pageLoadTimes.map((entry) => entry.LoadTime);

      const minLoadTime = Math.min(...loadTimes);
      const maxLoadTime = Math.max(...loadTimes);
      const averageLoadTime = loadTimes.reduce((total, time) => total + time, 0) / loadTimes.length;

      stats.push({ page: page.PageName, minLoadTime, maxLoadTime, averageLoadTime });
    }

    return stats;
  } catch (error) {
    console.error('Error calculating load time stats:', error);
    throw error;
  }
}

// Route for rendering the chart page
app.get('/', async (req, res) => {
  try {
    const pageNames = await getPageNames();
    const selectedPage = req.query.page || pageNames[0].PageName;

    const pageLoadTimes = await getPageLoadTimes(selectedPage);

    // Prepare the chart data
    const datasets = [{
      label: selectedPage,
      data: pageLoadTimes.map((entry) => entry.LoadTime),
      backgroundColor: 'rgba(0, 123, 255, 0.5)',
      borderColor: 'rgba(0, 123, 255, 1)',
      borderWidth: 1,
      fill: false,
    }];

    // Calculate load time statistics for all pages
    const loadTimeStats = await calculateLoadTimeStatsForAllPages(pageNames);

    // Create the HTML page with the chart, page selection options, and load time statistics table
    const chartHtml = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Page Load Time Chart</title>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body>
      <div>
        <h2>Select a Page:</h2>
        <select id="pageSelect" onchange="updateChart()">
          ${pageNames
            .map((page) => `<option value="${page.PageName}" ${page.PageName === selectedPage ? 'selected' : ''}>${page.PageName}</option>`)
            .join('')}
        </select>
      </div>
      <canvas id="chartCanvas"></canvas>
      <div>
        <h2>Load Time Statistics:</h2>
        <table>
          <tr>
            <th>Page</th>
            <th>Minimum Load Time (ms)</th>
            <th>Maximum Load Time (ms)</th>
            <th>Average Load Time (ms)</th>
          </tr>
          ${loadTimeStats
            .map((stat) => `
              <tr>
                <td>${stat.page}</td>
                <td>${stat.minLoadTime.toFixed(2)}</td>
                <td>${stat.maxLoadTime.toFixed(2)}</td>
                <td>${stat.averageLoadTime.toFixed(2)}</td>
              </tr>
            `)
            .join('')}
        </table>
      </div>
      <script>
        function updateChart() {
          const selectedPage = document.getElementById('pageSelect').value;
          const url = new URL(window.location.href);
          url.searchParams.set('page', selectedPage);
          window.location.href = url.toString();
        }

        const ctx = document.getElementById('chartCanvas').getContext('2d');
        const chartConfig = {
          type: 'bar',
          data: {
            labels: ['Load Time (ms)'],
            datasets: ${JSON.stringify(datasets)},
          },
          options: {
            responsive: true,
            title: {
              display: true,
              text: 'Page Load Time',
            },
            scales: {
              x: {
                display: false,
              },
              y: {
                display: true,
                title: {
                  display: true,
                  text: 'Load Time (ms)',
                },
              },
            },
          },
        };
        new Chart(ctx, chartConfig);
      </script>
    </body>
    </html>
    `;

    // Set the response headers
    res.setHeader('Content-Type', 'text/html');
    res.send(chartHtml);
  } catch (error) {
    console.error('Error generating chart:', error);
    res.status(500).send('Error generating chart');
  }
});

// Start the server
app.listen(3000, () => {
  console.log(`Server is listening on http://localhost:3000`);
});
