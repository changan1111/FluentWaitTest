// Route for rendering the chart page
app.get('/', async (req, res) => {
  try {
    const pageLoadTimes = await getPageLoadTimes();

    // Prepare the chart data
    const pageData = {}; // Object to store data for each page

    // Iterate over the page load times and populate the pageData object
    pageLoadTimes.forEach((entry) => {
      const pageName = entry.PageName;
      const loadTime = entry.LoadTime;

      // If the page data does not exist, create a new array
      if (!pageData[pageName]) {
        pageData[pageName] = [];
      }

      // Add the load time to the page data array
      pageData[pageName].push(loadTime);
    });

    // Create the HTML page with the chart
    const chartHtml = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Page Load Time Chart</title>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body>
      <canvas id="chartCanvas"></canvas>
      <script>
        const ctx = document.getElementById('chartCanvas').getContext('2d');
        const chartConfig = {
          type: 'bar',
          data: {
            labels: [],
            datasets: ${JSON.stringify(
              Object.entries(pageData).map(([pageName, loadTimes]) => ({
                label: pageName,
                data: loadTimes,
                backgroundColor: getRandomColor(),
                borderColor: getRandomColor(),
                fill: false
              }))
            )}
          },
          options: {
            responsive: true,
            title: {
              display: true,
              text: 'Page Load Time'
            },
            scales: {
              x: {
                display: false // Hide x-axis labels
              },
              y: {
                display: true,
                title: {
                  display: true,
                  text: 'Load Time (ms)'
                }
              }
            }
          }
        };
        new Chart(ctx, chartConfig);
      </script>
    </body>
    </html>
    `;

    // Set the response headers
    res.setHeader('Content-Type', 'text/html');
    res.send(chartHtml);
  } catch (error) {
    console.error('Error generating chart:', error);
    res.status(500).send('Error generating chart');
  }
});
