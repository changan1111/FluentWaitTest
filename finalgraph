// Route for rendering the chart page
app.get('/', async (req, res) => {
  try {
    const pageLoadTimes = await getPageLoadTimes();

    // Prepare the chart data
    const runLabels = []; // Array of run labels
    const datasets = []; // Array of datasets for each page

    // Iterate over the page load times and populate the runLabels and datasets arrays
    pageLoadTimes.forEach((entry, index) => {
      const runLabel = `Run ${index + 1}`;

      // Add the run label to the runLabels array
      runLabels.push(runLabel);

      // Create a new dataset for the page
      const dataset = {
        label: entry.PageName,
        data: [entry.LoadTime],
        backgroundColor: getRandomColor(),
        borderColor: getRandomColor(),
        fill: false
      };
      datasets.push(dataset);
    });

    // Create the HTML page with the chart
    const chartHtml = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Page Load Time Chart</title>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body>
      <canvas id="chartCanvas"></canvas>
      <script>
        const ctx = document.getElementById('chartCanvas').getContext('2d');
        const chartConfig = {
          type: 'bar',
          data: {
            labels: ${JSON.stringify(runLabels)},
            datasets: ${JSON.stringify(datasets)}
          },
          options: {
            responsive: true,
            title: {
              display: true,
              text: 'Page Load Time'
            },
            scales: {
              x: {
                display: true,
                title: {
                  display: true,
                  text: 'Run'
                }
              },
              y: {
                display: true,
                title: {
                  display: true,
                  text: 'Load Time (ms)'
                }
              }
            }
          }
        };
        new Chart(ctx, chartConfig);
      </script>
    </body>
    </html>
    `;

    // Set the response headers
    res.setHeader('Content-Type', 'text/html');
    res.send(chartHtml);
  } catch (error) {
    console.error('Error generating chart:', error);
    res.status(500).send('Error generating chart');
  }
});
